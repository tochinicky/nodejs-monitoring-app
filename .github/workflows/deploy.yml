name: Deploy Node.js App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy via SSH
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          VM_USER: ${{ secrets.VM_USER }}
          VM_IP: ${{ secrets.VM_IP }}
          DOMAIN: ${{ secrets.DOMAIN }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=accept-new "${VM_USER}@${VM_IP}" << 'EOF'
          set -euxo pipefail

          # Install Node.js 18.x with bundled npm
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # Install system dependencies
          sudo apt-get update
          sudo apt-get install -y nginx certbot python3-certbot-nginx

          # Install PM2 globally
          sudo npm install -g pm2

          # Setup application directory
          APP_DIR="/home/${VM_USER}/nodejs-app"
          if [ ! -d "${APP_DIR}" ]; then
            git clone https://github.com/tochinicky/nodejs-monitoring-app.git "${APP_DIR}"
          fi

          cd "${APP_DIR}"
          git reset --hard
          git pull origin main
          npm install

          # Manage application process
          pm2 delete nodeapp || true
          pm2 start app.js --name nodeapp
          pm2 save
          sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ${VM_USER} --hp /home/${VM_USER}

          # Configure Nginx
          sudo tee /etc/nginx/sites-available/nodeapp > /dev/null << NGINX_CFG
          server {
              listen 80;
              server_name ${DOMAIN};
              return 301 https://\$host\$request_uri;
          }

          server {
              listen 443 ssl;
              server_name ${DOMAIN};

              ssl_certificate /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;
              include /etc/letsencrypt/options-ssl-nginx.conf;

              location / {
                  proxy_pass http://localhost:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host \$host;

                  add_header X-Frame-Options DENY;
                  add_header X-XSS-Protection "1; mode=block";
                  add_header X-Content-Type-Options nosniff;
                  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
              }
          }
          NGINX_CFG

          # Enable site configuration
          sudo ln -sf /etc/nginx/sites-available/nodeapp /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl restart nginx

          # Obtain SSL certificate
          sudo certbot --nginx -n --agree-tos -m ${CERTBOT_EMAIL} -d ${DOMAIN}

          # Final restart to ensure SSL is loaded
          sudo systemctl restart nginx
          EOF
